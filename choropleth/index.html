<!DOCTYPE html>
<meta charset="utf-8">
<style>
	.counties {
		fill: none;
	}

	.states {
		fill: none;
		stroke: #cfcfcf;
		stroke-width: 0.5;
		stroke-linejoin: round;
	}

	.d3-tip {
		font-family: "Quick";
		line-height: 1.0;
		font-size: 10px;
		padding: 8px;
		background: rgba(0, 0, 0, 0.8);
		color: #cfcfcf;
		border-radius: 4px;
		text-align: center;
	}

	.choropleth {}

	.distribution {
		background-color: blueviolet;
		display: block;
		height: 100px;
		width: 150px;
	}

	@font-face {
		font-family: "Quick";
		src: url(Quick.ttf);
	}
</style>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script>

	const RED = "#FC4445";
	const BLUE = "#5E2BFF";
	const YELLOW = "#F9DC5c";
	const AQUA = "#0F7173";
	const LIGHT_GREEN = "#56E39F";
	const ORANGE = "#F18F01";
	const BRIGHT_GREEN = "#4CB944";
	const WHITE = "#CAFAFE";
	const SKY = "#55BCC9";
	const MIDNIGHT = "#0B132B";

	var selected_counties = [];

	const margin = {
		choropleth: { top: 20, right: 20, bottom: 20, left: 20 },
		distribution: { top: 10, right: 10, bottom: 10, left: 10 },
	}
	const width = {
		choropleth: 500 - margin.choropleth.left - margin.choropleth.right,
		distribution: 300 - margin.distribution.left - margin.distribution.right
	}
	const height = {
		choropleth: 300 - margin.choropleth.top - margin.choropleth.bottom,
		distribution: 200 - margin.distribution.top - margin.distribution.bottom
	}

	var svg = d3.select("svg");

	tip = d3.tip()
		.attr('class', 'd3-tip')
		.offset([-10, 0])
		.direction('n')
		.html(function (d) {
			console.log(d);
			return "<br/>OD Mortality Rate: " + d.od_mortality_rate;
		});

	svg.call(tip);

	// TODO: Add distribution plot to top-right corner
	// var dist_data = d3.range(1000).map(d3.random.normal(20, 5));

	// var dist_xmax = d3.max(dist_data);
	// var dist_xmin = d3.min(dist_data);
	// var dist_x = d3.scale.linear()
	// 	.domain([dist_xmin, dist_xmax])
	// 	.range([0, width.distribution]);

	// var dist_hist = d3.layout.histogram()
	// 	.bins(dist_x.ticks(20))
	// 	(dist_data);

	// var color = "steelblue";

	// var dist_yMax = d3.max(dist_hist, function (d) { return d.length });
	// var dist_yMin = d3.min(dist_hist, function (d) { return d.length });
	// var dist_colorScale = d3.scale.linear()
	// 	.domain([dist_yMin, dist_yMax])
	// 	.range([d3.rgb(color).brighter(), d3.rgb(color).darker()]);

	// var dist_y = d3.scale.linear()
	// 	.domain([0, dist_yMax])
	// 	.range([height.distribution, 0]);


	// var dist_xAxis = d3.svg.axis()
	// 	.scale(dist_x)
	// 	.orient("bottom");



	var fips = d3.map();

	var path = d3.geoPath();

	var x = d3.scaleLinear()
		.domain([1, 10])
		.rangeRound([600, 860]);

	var color = d3.scaleLinear().domain([0, 87])
		.range([AQUA, RED])
		.interpolate(d3.interpolateCubehelix);

	var promises = [
		d3.json("https://d3js.org/us-10m.v1.json"),
		d3.csv("./data/county_health_rankings.csv", function (d) { fips.set(d.FIPS, +d["Drug Overdose Mortality Rate"]); }),

	]

	Promise.all(promises).then(ready)

	function ready([us]) {


		svg.append("g")
			.attr("class", "choropleth");

		svg.append("g")
			.attr("class", "distribution")
			.attr('transform', `translate(${margin.choropleth.left + width.choropleth + margin.choropleth.right + margin.distribution.left}, ${margin.distribution.top})`);

		var choropleth = svg.select(".choropleth").attr("width", width.choropleth)
			.attr("height", height.choropleth);


		var distribution = svg.select(".distribution")
			.attr("width", width.distribution)
			.attr("height", height.distribution);

		console.log(us);
		choropleth.append("g")
			.attr("class", "counties")
			.selectAll("path")
			.data(topojson.feature(us, us.objects.counties).features)
			.enter().append("path")
			.on("mouseover", function (d, i) {
				tip.show(d, this);
			})
			.on("click", function (d, i) {

				selected_counties.push(d.id);
				svg.select()
				console.log(selected_counties);

				svg.selectAll(".counties")
					.attr("fill-opacity", 0.7);

				d3.select(this)
					.attr("fill-opacity", 1.0);

			})
			.attr("fill", function (d) { return color(d.od_mortality_rate = fips.get(d.id)); })
			.attr("d", path)
			.append("title")
			.text(function (d) { return d.rate + "%"; });

		choropleth.append("path")
			.datum(topojson.mesh(us, us.objects.states, function (a, b) { return a !== b; }))
			.attr("class", "states")
			.attr("d", path);
	}

</script>